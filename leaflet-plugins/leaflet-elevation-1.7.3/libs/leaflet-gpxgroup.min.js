L.Mixin.Selectable={includes:L.Mixin.Events,setSelected:function(a){a=!!a;this._selected!==a&&(this._selected=a,this.fire("selected"))},isSelected:function(){return!!this._selected}};L.Mixin.Selection={includes:L.Mixin.Events,getSelection:function(){return this._selected},setSelection:function(a){this._selected===a?null!==a&&(a.setSelected(!a.isSelected()),a.isSelected()||(this._selected=null)):(this._selected&&this._selected.setSelected(!1),(this._selected=a)&&this._selected.setSelected(!0));this.fire("selection_changed")}};
L.Control.LayersLegend=L.Control.Layers.extend({_onInputClick:function(){var a=this._layerControlInputs,b,c;this._handlingClick=!0;for(var d=a.length-1;0<=d;d--)b=a[d],c=this._getLayer(b.layerId).layer,b.checked&&this._map.fireEvent("legend_selected",{layer:c,input:b},!0);this._handlingClick=!1;this._refocusOnMap()}});L.control.layersLegend=function(a,b,c){return new L.Control.LayersLegend(a,b,c)};L.GeoJSON.include(L.Mixin.Selectable);
L.GpxGroup=L.Class.extend({options:{highlight:{color:"#ff0",opacity:1},points:[],points_options:{icon:{iconUrl:"../images/elevation-poi.png",iconSize:[12,12]}},flyToBounds:!0,legend:!1,legend_options:{position:"topright",collapsed:!1},elevation:!0,elevation_options:{theme:"yellow-theme",detachedView:!0,elevationDiv:"#elevation-div"},distanceMarkers:!0,distanceMarkers_options:{lazy:!0}},initialize:function(a,b){L.Util.setOptions(this,b);this._loadedCount=this._count=0;this._tracks=a;this._routes={};
this._layers=L.featureGroup();this._markers=L.featureGroup();this._elevation=L.control.elevation(this.options.elevation_options);this._legend=L.control.layersLegend(null,null,this.options.legend_options);var c=L.icon(this.options.points_options.icon);this.options.points.forEach(function(a){var b=L.marker(a.latlng,{icon:c});b.bindTooltip(a.name,{direction:"auto"});b.addTo(this._markers)},this);"undefined"===typeof L.DistanceMarkers&&(this.options.distanceMarkers=!1)},getBounds:function(){return this._layers.getBounds()},
addTo:function(a){this._layers.addTo(a);this._markers.addTo(a);this._map=a;this.on("selection_changed",this._onSelectionChanged,this);this._map.on("legend_selected",this._onLegendSelected,this);this._tracks.forEach(this.addTrack,this)},addTrack:function(a){var b=this;fetch(a).then(function(c){c.ok&&c.text().then(function(c){var d;c=c.trim();try{var f=(new DOMParser).parseFromString(c,"text/xml"),h=f.documentElement.tagName.toLowerCase(),g=f.getElementsByTagName("name");h in toGeoJSON||(h="TrainingCenterDatabase"==
f.documentElement.tagName?"tcx":"gpx");d=toGeoJSON[h](f);d.name=0<g.length?g[0].textContent:"";for(i=0;i<g.length;i++)if("trk"==g[i].parentElement.tagName){d.name=g[i].textContent;break}}catch(k){try{d=JSON.parse(c.toString()),d.name=d.name||""}catch(l){console.warn("Error parsing track: "+a)}}b._loadRoute(d)})})},_loadRoute:function(a){var b=this;if(a){var c={color:this._uniqueColors(this._tracks.length)[this._count++],opacity:.75,weight:5,distanceMarkers:this.options.distanceMarkers_options},d=
L.geoJson(a,{name:a.name||"",style:function(a){return c},distanceMarkers:c.distanceMarkers,originalStyle:c});d.addTo(this._layers);this._routes[d._leaflet_id]=d;d.eachLayer(function(a){return b._onRouteLayer(d,a)});this._onRouteLoaded(d)}},_onRouteLayer:function(a,b){a.on("selected",L.bind(this._onRouteSelected,this,a,b));b.on("mouseover",L.bind(this._onRouteMouseOver,this,a,b));b.on("mouseout",L.bind(this._onRouteMouseOut,this,a,b));b.on("click",L.bind(this._onRouteClick,this,a,b));b.bindTooltip(a.options.name,
{direction:"auto",sticky:!0})},highlight:function(a,b){"undefined"!=typeof b.setStyle&&b.setStyle(this.options.highlight);this.options.distanceMarkers&&b.addDistanceMarkers()},unhighlight:function(a,b){"undefined"!=typeof b.setStyle&&b.setStyle(a.options.originalStyle);this.options.distanceMarkers&&b.removeDistanceMarkers()},_onRouteMouseOver:function(a,b){a.isSelected()||(this.highlight(a,b),this.options.legend&&(this.setSelection(a),L.DomUtil.get("legend_"+a._leaflet_id).parentNode.previousSibling.click()));
this.fire("route_mouseover",{route:a,polyline:b})},_onRouteMouseOut:function(a,b){a.isSelected()||this.unhighlight(a,b);this.fire("route_mouseout",{route:a,polyline:b})},_onRouteClick:function(a,b){this.setSelection(a)},_onRouteSelected:function(a,b){a.isSelected()||this.unhighlight(a,b)},_onRouteLoaded:function(a){this.options.legend&&this._legend.addBaseLayer(a,'<svg id="legend_'+a._leaflet_id+'" width="25" height="10" version="1.1" xmlns="http://www.w3.org/2000/svg"><line x1="0" x2="50" y1="5" y2="5" stroke="'+
a.options.originalStyle.color+'" fill="transparent" stroke-width="5" /></svg> '+a.options.name);this.fire("route_loaded",{route:a});++this._loadedCount===this._tracks.length&&(this.fire("loaded"),this.options.flyToBounds&&this._map.flyToBounds(this.getBounds(),{duration:.25,easeLinearity:.25,noMoveStart:!0}),this.options.legend&&this._legend.addTo(this._map))},_onSelectionChanged:function(a){var b=this._elevation;a=b.getContainer();var c=this.getSelection();b.clear();c&&c.isSelected()?(a||b.loadChart(this._map),
c.getLayers().forEach(function(a){a instanceof L.Polyline&&(b.addData(a,!1),a.bringToFront())})):a&&b.remove()},_onLegendSelected:function(a){var b=this._layers._layers,c=a.layer;if(!c.isSelected()){this.setSelection(c);for(var d in c._layers)this.highlight(c,c._layers[d]);this._map.flyToBounds(a.layer.getBounds())}c=a.input.closest(".leaflet-control-layers-list");c.scroll({top:a.input.offsetTop-c.offsetTop||0,behavior:"smooth"});for(var e in b)a=b[e].isSelected(),c=L.DomUtil.get("legend_"+b[e]._leaflet_id),
c.querySelector("line").style.stroke=a?this.options.highlight.color:"",c.parentNode.style.fontWeight=a?"700":""},_uniqueColors:function(a){if(0===a)return[];if(1===a)return["#0000ff"];for(var b=1/a,c=[],d=0;d<a;++d){var e=this._hsvToRgb(d*b,1,.7),e="#"+this._rgbToHex(e[0],e[1],e[2]);c.push(e)}return c},_hsvToRgb:function(a,b,c){var d,e,f,h=Math.floor(6*a),g=6*a-h;a=c*(1-b);var k=c*(1-g*b);b=c*(1-(1-g)*b);switch(h%6){case 0:d=c;e=b;f=a;break;case 1:d=k;e=c;f=a;break;case 2:d=a;e=c;f=b;break;case 3:d=
a;e=k;f=c;break;case 4:d=b;e=a;f=c;break;case 5:d=c,e=a,f=k}return[255*d,255*e,255*f]},_rgbToHex:function(a,b,c){return this._byteToHex(a)+this._byteToHex(b)+this._byteToHex(c)},_byteToHex:function(a){return(a>>4&15).toString(16)+(a&15).toString(16)},removeFrom:function(a){this._layers.removeFrom(a)}});L.GpxGroup.include(L.Mixin.Events);L.GpxGroup.include(L.Mixin.Selection);L.gpxGroup=function(a,b){return new L.GpxGroup(a,b)};
